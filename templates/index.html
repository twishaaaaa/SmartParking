<!DOCTYPE html>
<html>
<head>
    <title>SCET Smart Parking Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-light container py-5">
    <h2 class="text-center mb-4">Smart Campus Parking System</h2>
    
    <audio id="successSound" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>
    <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <div class="row">
        <div class="col-md-6">
            <div class="card p-4 shadow-sm mb-4">
                <h4>Vehicle Registration</h4>
                <form action="/register" method="POST">
                    <input type="text" name="owner" class="form-control mb-2" placeholder="Owner Name" required>
                    <input type="text" name="contact" class="form-control mb-2" placeholder="Contact Details" required>
                    <input type="text" name="plate" class="form-control mb-2" placeholder="Plate No (e.g. GJ-05-BJ-8513)" required>
                    <select name="v_type" class="form-select mb-3">
                        <option value="2W">2-Wheeler (Bikes)</option>
                        <option value="4W">4-Wheeler (Cars)</option>
                    </select>
                    <button type="submit" class="btn btn-success w-100">Register & Generate QR</button>
                </form>
            </div>

            <div class="card p-4 shadow-sm border-warning">
                <h4>Security Guard Scanner</h4>
                <div id="reader"></div>
                <div id="scanFeedback" class="mt-3 fw-bold text-center"></div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-4 shadow-sm border-primary mb-3">
                <h4>Admin Owner Lookup</h4>
                <div class="input-group">
                    <input type="text" id="searchPlate" class="form-control" placeholder="Enter Plate Number">
                    <button class="btn btn-primary" onclick="searchOwner()">Search</button>
                </div>
                <div id="resultBox" class="alert alert-info mt-2 d-none"></div>
            </div>

            <div class="card p-4 shadow-sm bg-dark text-white mb-3">
                <h4>Live Capacity</h4>
                <p class="mb-1">2W Zone: {{ c2w }} / {{ cap['2W'] }}</p>
                <div class="progress mb-3"><div class="progress-bar bg-success" style="width: {{ (c2w/cap['2W'])*100 }}%"></div></div>
                <p class="mb-1">4W Zone: {{ c4w }} / {{ cap['4W'] }}</p>
                <div class="progress"><div class="progress-bar bg-info" style="width: {{ (c4w/cap['4W'])*100 }}%"></div></div>
            </div>

            <div class="card p-4 shadow-sm border-info">
                <h4>Recent Activity Log</h4>
                <table class="table table-sm mt-2">
                    <thead><tr><th>Time</th><th>Owner</th><th>Action</th></tr></thead>
                    <tbody id="activityLog"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Owner Search Logic
        async function searchOwner() {
            const plate = document.getElementById('searchPlate').value;
            const res = await fetch(`/lookup?plate=${plate}`);
            const box = document.getElementById('resultBox');
            if (res.ok) {
                const data = await res.json();
                box.classList.remove('d-none');
                box.innerHTML = `<strong>Owner:</strong> ${data.owner}<br><strong>Contact:</strong> ${data.contact}`;
            } else { alert("Vehicle Not Found!"); }
        }

        // QR Scanner Logic
        function onScanSuccess(decodedText) {
            const vId = decodedText.split(":")[1];
            fetch(`/scan/${vId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const feedback = document.getElementById('scanFeedback');
                    if(data.error) {
                        document.getElementById('errorSound').play();
                        feedback.className = "text-danger";
                        feedback.innerText = "DENIED: " + data.error;
                    } else {
                        document.getElementById('successSound').play();
                        feedback.className = "text-success";
                        feedback.innerText = `APPROVED: ${data.owner}`;
                        
                        // Add to live table
                        const log = document.getElementById('activityLog');
                        const row = log.insertRow(0);
                        row.innerHTML = `<td>${data.time.split(' ')[1]}</td><td>${data.owner}</td><td><b>${data.status}</b></td>`;
                        if(log.rows.length > 5) log.deleteRow(5);
                    }
                });
        }
        let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess);
    </script>
</body>
</html>